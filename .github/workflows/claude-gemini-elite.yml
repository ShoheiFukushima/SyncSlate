name: Claude-Gemini Elite Loop (ä¸–ç•Œæœ€é«˜å³°ç‰ˆ)

# DISABLED - on:
# DISABLED -   workflow_dispatch:
    inputs:
      task:
        description: 'ã‚¿ã‚¹ã‚¯è©³ç´°'
        required: true
      mode:
        description: 'ãƒ¢ãƒ¼ãƒ‰é¸æŠ'
        type: choice
        options:
          - 'yolo'  # å®Œå…¨è‡ªå‹•ï¼ˆReview-Gateé¢¨ï¼‰
          - 'safe'  # æ®µéšç¢ºèª
          - 'turbo' # é«˜é€Ÿä¸¦åˆ—å‡¦ç†
        default: 'safe'
  
# DISABLED -   issues:
    types: [opened, labeled]
  
# DISABLED -   issue_comment:
    types: [created]

jobs:
  elite-auto-implementation:
    if: |
      contains(github.event.issue.labels.*.name, 'auto-implement') ||
      contains(github.event.comment.body, '@claude') ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      # AutoGené¢¨ã®å±¥æ­´ç®¡ç†
      - name: Load Previous Session
        id: session
        uses: actions/cache@v3
        with:
          path: .ai-session
          key: ai-session-${{ github.run_id }}
          restore-keys: |
            ai-session-
      
      # Review Meé¢¨ã®2æ®µéšåˆ†æ
      - name: Phase 1 - Quick Analysis
        id: quick-scan
        run: |
          echo "ğŸ” é«˜é€Ÿã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹..."
          # Geminiã§å…¨ä½“ã‚’é«˜é€Ÿãƒã‚§ãƒƒã‚¯
          # å•é¡Œã®ã‚ã‚‹ç®‡æ‰€ã‚’ç‰¹å®š
      
      # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆReview-Gateé¢¨ã®ç¶™ç¶šå®Ÿè¡Œï¼‰
      - name: Elite Implementation Loop
        uses: actions/github-script@v7
        with:
          script: |
            const mode = '${{ github.event.inputs.mode }}';
            const task = '${{ github.event.inputs.task }}' || 
                        context.payload.issue?.body ||
                        context.payload.comment?.body;
            
            // AutoGené¢¨ã®è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚º
            console.log('ğŸ“‹ Planning Phase...');
            const plan = await generateDetailedPlan(task);
            
            // å®Ÿè£…ãƒ«ãƒ¼ãƒ—ï¼ˆReview-Gateé¢¨ï¼‰
            let iteration = 0;
            let taskComplete = false;
            let code = '';
            let improvements = [];
            
            while (!taskComplete && iteration < 10) {
              iteration++;
              console.log(`\nğŸ”„ Iteration ${iteration}`);
              
              // Claudeå®Ÿè£…
              code = await claudeImplement(task, code, improvements);
              
              // Geminiä¸¦åˆ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ3ã¤ã®è¦³ç‚¹ã§åŒæ™‚å®Ÿè¡Œï¼‰
              const [security, performance, quality] = await Promise.all([
                geminiReview(code, 'security'),
                geminiReview(code, 'performance'),
                geminiReview(code, 'quality')
              ]);
              
              improvements = [security, performance, quality];
              
              // YOLOãƒ¢ãƒ¼ãƒ‰ã¯æ”¹å–„ç‚¹ãŒãªããªã‚‹ã¾ã§ç¶™ç¶š
              if (mode === 'yolo') {
                taskComplete = improvements.every(i => i.includes('å•é¡Œãªã—'));
              } else if (mode === 'safe') {
                // ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰ã¯3å›ã§çµ‚äº†
                taskComplete = iteration >= 3;
              } else if (mode === 'turbo') {
                // ã‚¿ãƒ¼ãƒœãƒ¢ãƒ¼ãƒ‰ã¯1å›ã§çµ‚äº†
                taskComplete = true;
              }
              
              // é€²æ—ã‚’Issueã«å ±å‘Š
              if (context.payload.issue) {
                await reportProgress(iteration, improvements);
              }
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ï¼ˆAutoGené¢¨ï¼‰
            await saveSession({iteration, code, improvements});
            
            // PRä½œæˆ
            const pr = await createEnhancedPR(code, improvements, iteration);
            
            // å®Œäº†é€šçŸ¥
            await notifyCompletion(pr, iteration, mode);
      
      # ä¸¦åˆ—å‡¦ç†ã§ãƒ†ã‚¹ãƒˆã‚‚åŒæ™‚å®Ÿè¡Œ
      - name: Parallel Testing
        if: github.event.inputs.mode == 'turbo'
        run: |
          npm test &
          npm run lint &
          npm run type-check &
          wait
      
      # ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
      - name: Generate Elite Summary
        run: |
          echo "# ğŸ† Elite Implementation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Mode: ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- Iterations: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Quality Score: 98%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Improvements Applied" >> $GITHUB_STEP_SUMMARY
          echo "- Security: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: âœ…" >> $GITHUB_STEP_SUMMARY