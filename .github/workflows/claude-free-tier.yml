name: Claude Review (Free Tier Optimized)

# DISABLED - on:
# DISABLED -   issue_comment:
    types: [created]
# DISABLED -   pull_request_review_comment:
    types: [created]

jobs:
  claude-review:
    # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      contains(github.event.comment.body, '@claude') &&
      github.event.issue.pull_request
    
    runs-on: ubuntu-latest  # æœ€ã‚‚å®‰ä¾¡ãªãƒ©ãƒ³ãƒŠãƒ¼
    timeout-minutes: 2      # 2åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç„¡æ–™æ ç¯€ç´„ï¼‰
    
    permissions:
      pull-requests: write
      issues: write
    
    steps:
      # æœ€å°é™ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # å±¥æ­´ã‚’å–å¾—ã—ãªã„ï¼ˆé«˜é€ŸåŒ–ï¼‰
          
      # PRæƒ…å ±ã®å–å¾—
      - name: Get PR Info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆè»½é‡ï¼‰
          gh pr view $PR_NUMBER --json files -q '.files[].path' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
          
      # Claude APIã‚’ç›´æ¥å‘¼ã³å‡ºã—ï¼ˆè»½é‡å®Ÿè£…ï¼‰
      - name: Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.pr_number }}
          
          # PR diffã‚’å–å¾—ï¼ˆæœ€å¤§5000æ–‡å­—ã«åˆ¶é™ï¼‰
          DIFF=$(gh pr diff $PR_NUMBER | head -c 5000)
          
          # Claude APIã‚’curlã§ç›´æ¥å‘¼ã³å‡ºã—ï¼ˆé«˜é€Ÿï¼‰
          REVIEW=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-3-haiku-20240307\",
              \"max_tokens\": 500,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"ç°¡æ½”ã«ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§3ç‚¹ï¼‰:\\n$DIFF\"
              }]
            }" | jq -r '.content[0].text')
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
          gh pr comment $PR_NUMBER --body "## ğŸ¤– Claude Review
          
          $REVIEW
          
          ---
          *Generated by Claude (Free Tier Mode)*"
          
      # ã‚¨ãƒ©ãƒ¼æ™‚ã®ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      - name: Fallback Message
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.pr_number }}
          gh pr comment $PR_NUMBER --body "âš ï¸ Claude review failed. Please check manually."