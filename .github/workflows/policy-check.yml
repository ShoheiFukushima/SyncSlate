name: policy-check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  enforce-project-root:
    name: Enforce project root boundaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed files
        id: changes
        uses: tj-actions/changed-files@v45

      - name: Fail if paths are outside project structure
        run: |
          echo "Changed files:"
          printf '%s\n' ${{ steps.changes.outputs.all_changed_files }}
          BLOCK_PATTERNS='(^/Users/|^/home/|^/var/|^/tmp/|^/private/|^/Volumes/|^/mnt/|^/etc/|^/opt/|^/Applications/)'
          VIOLATIONS=0
          while IFS= read -r f; do
            if echo "$f" | grep -Eq "$BLOCK_PATTERNS"; then
              echo "::error title=Forbidden path detected:: $f"
              VIOLATIONS=1
            fi
          done < <(printf '%s\n' ${{ steps.changes.outputs.all_changed_files }})

          # Additional doc location rule (warning-level)
          while IFS= read -r f; do
            base=$(basename "$f")
            case "$base" in
              *.md|*.adoc|*.rst)
                if echo "$f" | grep -Eq '^docs/'; then
                  : # OK
                else
                  echo "::warning title=Doc outside docs/:: $f"
                fi
              ;;
            esac
          done < <(printf '%s\n' ${{ steps.changes.outputs.all_changed_files }})

          if [ "$VIOLATIONS" -ne 0 ]; then
            echo "Policy check failed due to forbidden paths."
            exit 1
          fi
