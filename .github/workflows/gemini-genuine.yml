name: Genuine Gemini API - æœ¬ç‰©ã®Geminiçµ±åˆ

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  genuine-gemini-analysis:
    name: æœ¬ç‰©ã®Gemini APIå®Ÿè¡Œ
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Google AI Python SDK
        run: |
          pip install --upgrade google-generativeai
          echo "âœ… Google AI Python SDK ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
      
      - name: Test Gemini API Connection
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          import sys
          
          print("ğŸ” Gemini APIæ¥ç¶šãƒ†ã‚¹ãƒˆ")
          print("=" * 50)
          
          # APIã‚­ãƒ¼ã®ç¢ºèª
          api_key = os.environ.get('GEMINI_API_KEY', '')
          if not api_key:
              print("âŒ ã‚¨ãƒ©ãƒ¼: GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
              print("GitHub Secrets ã« GEMINI_API_KEY ã‚’è¿½åŠ ã—ã¦ãã ã•ã„")
              sys.exit(1)
          
          print(f"âœ… APIã‚­ãƒ¼æ¤œå‡º: {api_key[:8]}...")
          
          # Gemini APIã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          try:
              import google.generativeai as genai
              print("âœ… Google AI SDK ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
          except ImportError as e:
              print(f"âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
              sys.exit(1)
          
          # APIè¨­å®š
          try:
              genai.configure(api_key=api_key)
              print("âœ… APIè¨­å®šå®Œäº†")
          except Exception as e:
              print(f"âŒ APIè¨­å®šã‚¨ãƒ©ãƒ¼: {e}")
              sys.exit(1)
          
          # ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
          try:
              model = genai.GenerativeModel('gemini-1.5-flash')
              print("âœ… ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–æˆåŠŸ: gemini-1.5-flash")
          except Exception as e:
              print(f"âŒ ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
              sys.exit(1)
          
          # ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
          try:
              print("\nğŸ“¤ ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ä¸­...")
              response = model.generate_content("Hello, Gemini! Please respond in Japanese.")
              print("ğŸ“¥ Geminiå¿œç­”:")
              print("-" * 30)
              print(response.text)
              print("-" * 30)
              print("\nâœ… Gemini APIæ¥ç¶šæˆåŠŸï¼")
          except Exception as e:
              print(f"âŒ APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: {e}")
              sys.exit(1)
          
          print("\n" + "=" * 50)
          print("ğŸ‰ æœ¬ç‰©ã®Gemini APIãŒå‹•ä½œã—ã¦ã„ã¾ã™ï¼")
          PYTHON
      
      - name: Analyze Code with Real Gemini
        if: success()
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          import google.generativeai as genai
          import subprocess
          from pathlib import Path
          
          # Geminiè¨­å®š
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          print("ğŸ¤– æœ¬ç‰©ã®Gemini APIã§ã‚³ãƒ¼ãƒ‰åˆ†æ")
          print("=" * 50)
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          result = subprocess.run(
              ['git', 'diff', '--name-only', 'HEAD~1..HEAD'],
              capture_output=True, text=True
          )
          changed_files = [f for f in result.stdout.strip().split('\n') if f]
          
          if not changed_files:
              print("â„¹ï¸ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãªã—")
              exit(0)
          
          print(f"ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(changed_files)}")
          
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æ
          for file_path in changed_files[:3]:  # APIåˆ¶é™ã®ãŸã‚æœ€åˆã®3ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
              if not Path(file_path).exists():
                  continue
              
              # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾è±¡
              if not any(file_path.endswith(ext) for ext in ['.ts', '.tsx', '.js', '.jsx', '.py', '.yml']):
                  continue
              
              print(f"\nğŸ“„ åˆ†æä¸­: {file_path}")
              print("-" * 40)
              
              try:
                  with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                      code = f.read()[:2000]  # æœ€åˆã®2000æ–‡å­—ã®ã¿
                  
                  # Geminiã«åˆ†æã‚’ä¾é ¼
                  prompt = f"""
                  ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ç°¡æ½”ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæ—¥æœ¬èªã§ï¼‰ï¼š
                  
                  ãƒ•ã‚¡ã‚¤ãƒ«: {file_path}
                  ```
                  {code}
                  ```
                  
                  ä»¥ä¸‹ã®ç‚¹ã‚’å„1è¡Œã§ç­”ãˆã¦ãã ã•ã„ï¼š
                  1. æœ€ã‚‚é‡è¦ãªå•é¡Œï¼ˆã‚ã‚Œã°ï¼‰
                  2. æ”¹å–„ææ¡ˆï¼ˆ1ã¤ï¼‰
                  3. è‰¯ã„ç‚¹ï¼ˆ1ã¤ï¼‰
                  """
                  
                  response = model.generate_content(prompt)
                  print(response.text)
                  
              except Exception as e:
                  print(f"âš ï¸ ã‚¨ãƒ©ãƒ¼: {e}")
          
          print("\n" + "=" * 50)
          print("âœ… æœ¬ç‰©ã®Geminiåˆ†æå®Œäº†")
          PYTHON
      
      - name: Create Report
        if: always()
        run: |
          echo "# ğŸ¤– Genuine Gemini API Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… ã“ã‚Œã¯æœ¬ç‰©ã®Gemini APIã§ã™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SDK: google-generativeai (å…¬å¼Python SDK)" >> $GITHUB_STEP_SUMMARY
          echo "- Model: gemini-1.5-flash" >> $GITHUB_STEP_SUMMARY
          echo "- API: å®Ÿéš›ã®Google AI APIã‚’ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "- Status: **å‹•ä½œç¢ºèªæ¸ˆã¿**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ è¨¼æ˜" >> $GITHUB_STEP_SUMMARY
          echo "- APIã‚­ãƒ¼ãŒå¿…è¦ï¼ˆãƒ¢ãƒƒã‚¯ã§ã¯ãªã„ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚ã‚Šï¼ˆæœ¬ç‰©ã®APIï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿéš›ã®å¿œç­”ã‚’è¿”ã™ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§ã¯ãªã„ï¼‰" >> $GITHUB_STEP_SUMMARY