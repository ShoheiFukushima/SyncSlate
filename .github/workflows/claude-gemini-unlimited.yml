name: Claude-Gemini Unlimited Auto Loop

# DISABLED - on:
  # æ‰‹å‹•å®Ÿè¡Œ
# DISABLED -   workflow_dispatch:
    inputs:
      task:
        description: 'å®Ÿè£…ã—ãŸã„ã‚¿ã‚¹ã‚¯'
        required: true
        type: string
      iterations:
        description: 'æ”¹å–„å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰'
        default: '3'
        type: string
  
  # Issueã‹ã‚‰ã®è‡ªå‹•å®Ÿè¡Œ
# DISABLED -   issues:
    types: [opened, labeled]

jobs:
  auto-code-generation:
    if: contains(github.event.issue.labels.*.name, 'auto-implement') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    env:
      CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: |
          npm install @anthropic-ai/sdk
          npm install @google/generative-ai
          npm install @actions/github
      
      - name: Auto Implementation Loop
        uses: actions/github-script@v7
        with:
          script: |
            const Anthropic = require('@anthropic-ai/sdk');
            const { GoogleGenerativeAI } = require('@google/generative-ai');
            
            // Initialize APIs
            const claude = new Anthropic({
              apiKey: process.env.CLAUDE_API_KEY,
            });
            
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const gemini = genAI.getGenerativeModel({ model: "gemini-1.5-pro" });
            
            // ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
            const task = context.payload.inputs?.task || 
                        context.payload.issue?.body || 
                        'Implement a simple feature';
            
            const iterations = parseInt(context.payload.inputs?.iterations || '3');
            
            console.log(`ğŸ“‹ Task: ${task}`);
            console.log(`ğŸ”„ Iterations: ${iterations}`);
            
            // ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
            const branchName = `auto-impl-${Date.now()}`;
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: ref.object.sha
            });
            
            let code = '';
            let improvements = [];
            
            // æ”¹å–„ãƒ«ãƒ¼ãƒ—
            for (let i = 1; i <= iterations; i++) {
              console.log(`\nâ”â”â” Iteration ${i}/${iterations} â”â”â”`);
              
              if (i === 1) {
                // åˆå›å®Ÿè£…
                console.log('ğŸ¤– Claude: åˆå›å®Ÿè£…ä¸­...');
                const response = await claude.messages.create({
                  model: 'claude-3-opus-20240229',
                  max_tokens: 4000,
                  messages: [{
                    role: 'user',
                    content: `Task: ${task}\n\nGenerate complete, production-ready code with tests and documentation.`
                  }]
                });
                
                code = response.content[0].text;
                console.log('âœ… åˆå›å®Ÿè£…å®Œäº†');
                
              } else {
                // Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
                console.log('ğŸ” Gemini: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...');
                const review = await gemini.generateContent(`
                  Review this code and provide specific improvements:
                  
                  ${code}
                  
                  Focus on:
                  1. Bugs and security issues
                  2. Performance optimizations
                  3. Code quality and best practices
                  4. Missing edge cases
                `);
                
                const reviewText = review.response.text();
                improvements.push(reviewText);
                console.log('ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†');
                
                // Claudeã§æ”¹å–„
                console.log('ğŸ¤– Claude: æ”¹å–„ä¸­...');
                const improveResponse = await claude.messages.create({
                  model: 'claude-3-opus-20240229',
                  max_tokens: 4000,
                  messages: [{
                    role: 'user',
                    content: `Current code:\n${code}\n\nReview feedback:\n${reviewText}\n\nImprove the code based on this feedback.`
                  }]
                });
                
                code = improveResponse.content[0].text;
                console.log('âœ… æ”¹å–„å®Œäº†');
              }
              
              // ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
              const fileName = `implementation_v${i}.js`;
              const content = Buffer.from(code).toString('base64');
              
              try {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                const { data: existingFile } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: fileName,
                  ref: branchName
                }).catch(() => ({ data: null }));
                
                if (existingFile) {
                  // æ›´æ–°
                  await github.rest.repos.updateFile({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: fileName,
                    message: `Iteration ${i}: ${i === 1 ? 'Initial implementation' : 'Apply improvements'}`,
                    content: content,
                    sha: existingFile.sha,
                    branch: branchName
                  });
                } else {
                  // æ–°è¦ä½œæˆ
                  await github.rest.repos.createOrUpdateFileContents({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: fileName,
                    message: `Iteration ${i}: Initial implementation`,
                    content: content,
                    branch: branchName
                  });
                }
              } catch (error) {
                console.error(`Error saving file: ${error.message}`);
              }
            }
            
            // PRä½œæˆ
            console.log('\nğŸš€ Creating Pull Request...');
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– Auto: ${task.substring(0, 50)}...`,
              body: `## ğŸ¯ Task
            ${task}
            
            ## ğŸ”„ Improvement Cycles
            Completed ${iterations} automatic improvement cycles
            
            ## ğŸ“Š Improvements Made
            ${improvements.map((imp, i) => `### Cycle ${i + 2}\n${imp.substring(0, 500)}...`).join('\n\n')}
            
            ## âœ… Final Implementation
            The code has been:
            - Reviewed by Gemini AI ${iterations - 1} times
            - Improved by Claude AI based on feedback
            - Optimized for production use
            
            ## ğŸ·ï¸ Labels
            - \`auto-generated\`
            - \`ai-improved\`
            - \`ready-for-review\`
            
            ---
            *Generated by Claude-Gemini Unlimited Loop*`,
              head: branchName,
              base: 'main',
              draft: false
            });
            
            console.log(`âœ… PR created: #${pr.number}`);
            
            // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `âœ… è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nPR: #${pr.number}\næ”¹å–„ã‚µã‚¤ã‚¯ãƒ«: ${iterations}å›`
              });
            }
            
            // å®Œäº†é€šçŸ¥
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âœ… Auto Implementation Complete: ${task.substring(0, 50)}`,
              body: `## Summary
              - Task: ${task}
              - PR: #${pr.number}
              - Iterations: ${iterations}
              - Status: Ready for human review
              
              Please review and merge if satisfactory.`,
              labels: ['auto-complete', 'needs-review']
            });
      
      - name: Summary
        run: |
          echo "## ğŸ‰ Auto Implementation Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Task**: ${{ github.event.inputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Iterations**: ${{ github.event.inputs.iterations }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Ready for review" >> $GITHUB_STEP_SUMMARY