name: Claude Mention Response

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  respond-to-mention:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract mention context
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "CONTENT=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "CONTENT=${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Process with Claude API
        id: claude_response
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Extract the question/request after @claude mention
          CONTENT="${{ steps.extract.outputs.CONTENT }}"
          
          # Prepare the request for Claude
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-3-haiku-20240307\",
              \"max_tokens\": 1024,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"You are responding to a GitHub issue mention. The user said: $CONTENT\"
              }]
            }" | jq -r '.content[0].text // "Error processing request"')
          
          # Save response for next step
          echo "RESPONSE<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post response to issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.extract.outputs.ISSUE_NUMBER }};
            const response = `${{ steps.claude_response.outputs.RESPONSE }}`;
            
            // Add Claude's response as a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ¤– **Claude Response:**\n\n${response}\n\n---\n*This response was generated automatically via GitHub Actions*`
            });
      
      - name: Add reaction to original comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ github.event.comment.id }},
              content: 'rocket'
            });