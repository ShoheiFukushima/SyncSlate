name: JiT System Safe - APIåˆ¶é™å¯¾å¿œç‰ˆ

# DISABLED - on:
# DISABLED -   pull_request:
    types: [opened, synchronize]
# DISABLED -   push:
    branches: [main, master]
# DISABLED -   workflow_dispatch:
    inputs:
      force_run:
        description: 'APIåˆ¶é™ã‚’ç„¡è¦–ã—ã¦å¼·åˆ¶å®Ÿè¡Œ'
        type: boolean
        default: false

jobs:
  # APIä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
  check-api-limits:
    name: APIåˆ¶é™ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      usage_today: ${{ steps.check.outputs.usage_today }}
      remaining: ${{ steps.check.outputs.remaining }}
    
    steps:
      - name: Check API usage
        id: check
        run: |
          echo "ğŸ“Š APIä½¿ç”¨é‡ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # ä½¿ç”¨é‡è¿½è·¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆGitHub Artifactsã‹ã‚‰ï¼‰
          USAGE_FILE=".api-usage-$(date +%Y%m%d).json"
          
          # æœ¬æ—¥ã®ä½¿ç”¨é‡ã‚’ç¢ºèª
          if [ -f "$USAGE_FILE" ]; then
            USAGE_TODAY=$(cat "$USAGE_FILE" | jq -r '.gemini_calls // 0')
          else
            USAGE_TODAY=0
            echo '{"gemini_calls": 0, "date": "'$(date +%Y-%m-%d)'"}' > "$USAGE_FILE"
          fi
          
          # Gemini APIåˆ¶é™ï¼ˆ1æ—¥60å›ã¨ä»®å®šï¼‰
          DAILY_LIMIT=60
          REMAINING=$((DAILY_LIMIT - USAGE_TODAY))
          
          echo "ğŸ“ˆ æœ¬æ—¥ã®ä½¿ç”¨é‡: $USAGE_TODAY / $DAILY_LIMIT"
          echo "ğŸ“‰ æ®‹ã‚Š: $REMAINING"
          
          # å¼·åˆ¶å®Ÿè¡Œãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "âš ï¸ å¼·åˆ¶å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
            CAN_PROCEED="true"
          elif [ $REMAINING -gt 5 ]; then
            echo "âœ… APIåˆ¶é™å†…ã§ã™"
            CAN_PROCEED="true"
          else
            echo "âŒ APIåˆ¶é™ã«é”ã—ã¦ã„ã¾ã™"
            CAN_PROCEED="false"
            
            # åˆ¶é™åˆ°é”ã‚’é€šçŸ¥
            echo "::warning::Gemini API daily limit reached ($USAGE_TODAY/$DAILY_LIMIT). System paused."
          fi
          
          echo "can_proceed=$CAN_PROCEED" >> $GITHUB_OUTPUT
          echo "usage_today=$USAGE_TODAY" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT

  # ãƒ¡ã‚¤ãƒ³ã®JiTå‡¦ç†
  jit-safe-process:
    name: JiT Safe Processing
    needs: check-api-limits
    if: needs.check-api-limits.outputs.can_proceed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests pyyaml
      
      - name: Detect changes
        id: detect
        run: |
          echo "ğŸ” å¤‰æ›´ã‚’æ¤œçŸ¥ä¸­..."
          
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§å¤‰æ›´æ¤œçŸ¥
          set +e  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œ
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt 2>/dev/null || \
            git diff --name-only HEAD~1..HEAD > changed_files.txt
          else
            git diff --name-only HEAD~1..HEAD > changed_files.txt 2>/dev/null || \
            echo "No changes" > changed_files.txt
          fi
          
          set -e
          
          # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æŠ½å‡º
          grep -E '\.(ts|tsx|js|jsx|py|go|java)$' changed_files.txt > code_files.txt || echo "" > code_files.txt
          
          FILE_COUNT=$(wc -l < code_files.txt | tr -d ' ')
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "â„¹ï¸ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—"
          else
            echo "ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $FILE_COUNT"
            cat code_files.txt
          fi
      
      - name: Safe Review with fallback
        if: steps.detect.outputs.count > 0
        id: review
        run: |
          echo "ğŸ¤– ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹"
          
          # Pythonã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ããƒ¬ãƒ“ãƒ¥ãƒ¼
          python3 << 'PYTHON'
          import json
          import sys
          import os
          import time
          
          def safe_review_file(file_path):
              """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼"""
              try:
                  if not os.path.exists(file_path):
                      return None
                  
                  with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                      code = f.read()
                  
                  # åŸºæœ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ï¼ˆGemini APIã®ä»£æ›¿ï¼‰
                  issues = []
                  
                  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
                  dangerous_patterns = [
                      ('eval(', 'eval()ã®ä½¿ç”¨ã¯å±é™ºã§ã™'),
                      ('exec(', 'exec()ã®ä½¿ç”¨ã¯å±é™ºã§ã™'),
                      ('os.system', 'os.systemã®ä½¿ç”¨ã¯å±é™ºã§ã™'),
                      ('__import__', 'å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯æ…é‡ã«'),
                      ('password =', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°'),
                      ('api_key =', 'APIã‚­ãƒ¼ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°'),
                  ]
                  
                  for pattern, message in dangerous_patterns:
                      if pattern in code:
                          issues.append({
                              'type': 'security',
                              'message': message,
                              'severity': 'high'
                          })
                  
                  # å“è³ªãƒã‚§ãƒƒã‚¯
                  quality_patterns = [
                      ('console.log', 'ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã£ã¦ã„ã¾ã™'),
                      ('TODO', 'TODOã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™'),
                      ('FIXME', 'FIXMEã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™'),
                      ('debugger', 'debuggeræ–‡ãŒæ®‹ã£ã¦ã„ã¾ã™'),
                      ('print(', 'printæ–‡ãŒæ®‹ã£ã¦ã„ã¾ã™ï¼ˆPythonï¼‰'),
                  ]
                  
                  for pattern, message in quality_patterns:
                      if pattern in code:
                          issues.append({
                              'type': 'quality',
                              'message': message,
                              'severity': 'low'
                          })
                  
                  return {
                      'file': file_path,
                      'issues': issues,
                      'line_count': len(code.split('\n'))
                  }
                  
              except Exception as e:
                  print(f"âš ï¸ {file_path} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚¨ãƒ©ãƒ¼: {e}")
                  return None
          
          # ãƒ¡ã‚¤ãƒ³å‡¦ç†
          try:
              with open('code_files.txt', 'r') as f:
                  files = [line.strip() for line in f if line.strip()]
              
              reviews = []
              for file_path in files:
                  review = safe_review_file(file_path)
                  if review:
                      reviews.append(review)
                  
                  # APIåˆ¶é™å¯¾ç­–: å‡¦ç†é–“éš”ã‚’ç©ºã‘ã‚‹
                  time.sleep(0.1)
              
              # çµæœã‚’ä¿å­˜
              with open('review_results.json', 'w') as f:
                  json.dump(reviews, f, indent=2, ensure_ascii=False)
              
              total_issues = sum(len(r['issues']) for r in reviews)
              print(f"âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†: {len(reviews)}ãƒ•ã‚¡ã‚¤ãƒ«, {total_issues}ä»¶ã®æŒ‡æ‘˜")
              
          except Exception as e:
              print(f"âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: {e}")
              # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç©ºã®çµæœã‚’ä½œæˆ
              with open('review_results.json', 'w') as f:
                  json.dump([], f)
          PYTHON
      
      - name: Safe Auto Fix
        if: steps.detect.outputs.count > 0
        run: |
          echo "ğŸ”§ å®‰å…¨ãªè‡ªå‹•ä¿®æ­£"
          
          python3 << 'PYTHON'
          import json
          import re
          import os
          
          def safe_fix_file(file_path, issues):
              """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ä¿®æ­£"""
              try:
                  if not os.path.exists(file_path):
                      return False
                  
                  with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                      code = f.read()
                  
                  original = code
                  
                  # å®‰å…¨ãªä¿®æ­£ã®ã¿é©ç”¨
                  for issue in issues:
                      if issue['severity'] == 'low':
                          if 'console.log' in issue['message']:
                              code = re.sub(r'^(\s*)console\.log', r'\1// console.log', code, flags=re.MULTILINE)
                          elif 'print(' in issue['message']:
                              code = re.sub(r'^(\s*)print\(', r'\1# print(', code, flags=re.MULTILINE)
                  
                  if code != original:
                      # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
                      backup_path = f"{file_path}.backup"
                      with open(backup_path, 'w', encoding='utf-8') as f:
                          f.write(original)
                      
                      # ä¿®æ­£ã‚’é©ç”¨
                      with open(file_path, 'w', encoding='utf-8') as f:
                          f.write(code)
                      
                      return True
                  
                  return False
                  
              except Exception as e:
                  print(f"âš ï¸ {file_path} ã®ä¿®æ­£ã§ã‚¨ãƒ©ãƒ¼: {e}")
                  return False
          
          # ãƒ¡ã‚¤ãƒ³å‡¦ç†
          try:
              with open('review_results.json', 'r') as f:
                  reviews = json.load(f)
              
              fixed_count = 0
              for review in reviews:
                  if safe_fix_file(review['file'], review.get('issues', [])):
                      fixed_count += 1
                      print(f"âœ… {review['file']} ã‚’ä¿®æ­£")
              
              print(f"\nğŸ“Š {fixed_count}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ä¿®æ­£")
              
              # ã‚µãƒãƒªãƒ¼ä½œæˆ
              with open('fix_summary.md', 'w') as f:
                  f.write(f"# ğŸ”§ Safe Fix Summary\n\n")
                  f.write(f"- ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {fixed_count}\n")
                  f.write(f"- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæ¸ˆã¿\n")
                  f.write(f"- å®‰å…¨ãªä¿®æ­£ã®ã¿é©ç”¨\n")
              
          except Exception as e:
              print(f"âŒ ä¿®æ­£ã‚¨ãƒ©ãƒ¼: {e}")
          PYTHON
      
      - name: Update API usage
        if: always()
        run: |
          # APIä½¿ç”¨é‡ã‚’æ›´æ–°
          USAGE_FILE=".api-usage-$(date +%Y%m%d).json"
          
          if [ -f "$USAGE_FILE" ]; then
            CURRENT=$(cat "$USAGE_FILE" | jq -r '.gemini_calls // 0')
          else
            CURRENT=0
          fi
          
          # ä½¿ç”¨é‡ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆå®Ÿéš›ã®APIå‘¼ã³å‡ºã—æ•°ã«å¿œã˜ã¦èª¿æ•´ï¼‰
          NEW_USAGE=$((CURRENT + 1))
          
          echo '{"gemini_calls": '$NEW_USAGE', "date": "'$(date +%Y-%m-%d)'", "updated": "'$(date -Iseconds)'"}' > "$USAGE_FILE"
          
          echo "ğŸ“Š APIä½¿ç”¨é‡æ›´æ–°: $NEW_USAGE"
      
      - name: Create summary
        if: always()
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # ğŸ¤– JiT System Safe Mode Report
          
          ## ğŸ“Š APIä½¿ç”¨çŠ¶æ³
          - æœ¬æ—¥ã®ä½¿ç”¨é‡: ${{ needs.check-api-limits.outputs.usage_today }}/60
          - æ®‹ã‚Š: ${{ needs.check-api-limits.outputs.remaining }}
          
          ## ğŸ” å‡¦ç†çµæœ
          - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.detect.outputs.count }}
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼: âœ…
          - è‡ªå‹•ä¿®æ­£: âœ…
          
          ## âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          - APIåˆ¶é™ãƒã‚§ãƒƒã‚¯: âœ…
          - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†: æœ‰åŠ¹
          - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ä½œæˆæ¸ˆã¿
          
          ---
          *Safe mode enabled to prevent API limit issues*
          EOF

  # APIåˆ¶é™åˆ°é”æ™‚ã®é€šçŸ¥
  notify-limit:
    name: APIåˆ¶é™é€šçŸ¥
    needs: check-api-limits
    if: needs.check-api-limits.outputs.can_proceed == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - name: Create limit notification
        uses: actions/github-script@v7
        with:
          script: |
            // Issueã‚’ä½œæˆã—ã¦é€šçŸ¥
            const today = new Date().toISOString().split('T')[0];
            const title = `âš ï¸ Gemini APIåˆ¶é™åˆ°é” - ${today}`;
            const body = `## APIä½¿ç”¨åˆ¶é™ã«åˆ°é”ã—ã¾ã—ãŸ
            
            - æœ¬æ—¥ã®ä½¿ç”¨é‡: ${{ needs.check-api-limits.outputs.usage_today }}/60
            - æ®‹ã‚Š: ${{ needs.check-api-limits.outputs.remaining }}
            
            ### å¯¾å¿œæ–¹æ³•
            1. æ˜æ—¥ã¾ã§å¾…ã¤ï¼ˆè‡ªå‹•ãƒªã‚»ãƒƒãƒˆï¼‰
            2. ç·Šæ€¥ã®å ´åˆã¯ force_run ã§å¼·åˆ¶å®Ÿè¡Œ
            3. æ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ### è‡ªå‹•å†é–‹
            æ˜æ—¥0æ™‚ï¼ˆUTCï¼‰ã«è‡ªå‹•çš„ã«å†é–‹ã•ã‚Œã¾ã™ã€‚
            
            ---
            *JiT System Safe Mode*`;
            
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['api-limit', 'jit-system']
              });
            } catch (e) {
              console.log('Issue creation failed:', e);
            }