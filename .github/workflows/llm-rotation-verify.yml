name: LLM Rotation Verification

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to verify (pull request number)'
        required: true
        default: '2'
      post_comment:
        description: 'Whether to post comment to PR (true/false)'
        required: false
        default: 'false'

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-llm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Prepare verify event
        run: |
          mkdir -p tmp/out
          echo "{\"pull_request\":{\"number\": ${{ github.event.inputs.pr_number }}, \"base\":{\"ref\":\"main\"}}}" > tmp/verify_event.json

      - name: Run PR LLM review runner (capture logs)
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p tmp/out
          if [ "${{ github.event.inputs.post_comment }}" = "true" ]; then
            node scripts/pr-review-runner.js --local --event tmp/verify_event.json --post > tmp/out/pr-review-runner.stdout.txt 2>&1 || true
          else
            node scripts/pr-review-runner.js --local --event tmp/verify_event.json > tmp/out/pr-review-runner.stdout.txt 2>&1 || true
          fi

      - name: Detect LLM auth errors and produce guidance
        run: |
          set -e
          mkdir -p tmp/out
          if grep -E "LLM API returned non-OK|LLM API call failed|status 401|status 403|invalid_api_key|Incorrect API key|401" tmp/out/pr-review-runner.stdout.txt >/dev/null 2>&1; then
            cat > tmp/out/admin-guidance.txt <<'EOF'
Automated LLM Review (bot) — ERROR: LLM API call failed during verification.

Possible causes:
- The repository secret `LLM_API_KEY` is invalid or expired.
- A non-OpenAI provider key (e.g., Google API key starting with "AIza") was uploaded by mistake.
- Network or provider-side error.

Recommended actions:
1. Remove current secret and re-add a valid OpenAI-style API key:
   - GitHub UI: Settings → Secrets and variables → Actions → New repository secret
     Name: LLM_API_KEY
   - Or use CLI: gh secret set LLM_API_KEY --body "<NEW_KEY>" --repo ${{ github.repository }}
2. Re-run this verification workflow.
3. If error persists, inspect the runner log: tmp/out/pr-review-runner.stdout.txt and escalate.

This guidance was generated automatically to help maintainers restore the LLM reviewer.
EOF
          fi

      - name: Upload verification artifacts
        uses: actions/upload-artifact@v4
        with:
          name: llm-rotation-verify-output
          path: tmp/out
          if-no-files-found: warn