name: JiT Improvement (Just in Time æ”¹å–„)

# freeeã®JiTãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ã‚’å¿œç”¨ã—ãŸè‡ªå‹•æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ 

# DISABLED - on:
# DISABLED -   pull_request:
    types: [opened, synchronize]
# DISABLED -   push:
    branches: [main]

jobs:
  jit-improve:
    name: Just in Time ã‚³ãƒ¼ãƒ‰æ”¹å–„
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # JiTãƒ†ã‚¹ãƒˆé¢¨: å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦å³åº§ã«æ”¹å–„
      - name: Detect Changes
        id: changes
        run: |
          echo "ğŸ“ å¤‰æ›´æ¤œçŸ¥ï¼ˆJiTæ–¹å¼ï¼‰"
          git diff --name-only HEAD~1..HEAD > changed_files.txt
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # ã‚¹ãƒ†ãƒƒãƒ—1: Geminiã§å³åº§ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆJiT Reviewï¼‰
      - name: JiT Review by Gemini
        id: review
        run: |
          echo "ğŸ” Just in Time ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹"
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼
          for file in $(cat changed_files.txt); do
            echo "Reviewing: $file"
            
            # ã“ã“ã§Gemini APIã‚’å‘¼ã¶ï¼ˆç°¡ç•¥åŒ–ï¼‰
            cat << 'EOF' > review_$file.md
          ## $file ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
          
          ### ğŸ› æ½œåœ¨çš„ãƒã‚°
          - nullãƒã‚§ãƒƒã‚¯ä¸è¶³ã®å¯èƒ½æ€§
          
          ### âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
          - ãƒ«ãƒ¼ãƒ—å†…ã§ã®APIå‘¼ã³å‡ºã—ã‚’æ¤œå‡º
          
          ### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - å…¥åŠ›å€¤ã®æ¤œè¨¼ãŒå¿…è¦
          EOF
          done
      
      # ã‚¹ãƒ†ãƒƒãƒ—2: Claudeã§å³åº§ã«ä¿®æ­£ï¼ˆJiT Fixï¼‰
      - name: JiT Fix by Claude
        id: fix
        run: |
          echo "ğŸ”§ Just in Time ä¿®æ­£é–‹å§‹"
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’åŸºã«è‡ªå‹•ä¿®æ­£
          for file in $(cat changed_files.txt); do
            if [ -f "review_$file.md" ]; then
              echo "Fixing: $file based on review"
              
              # å®Ÿéš›ã®ä¿®æ­£ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¾‹ï¼‰
              # - nullãƒã‚§ãƒƒã‚¯è¿½åŠ 
              # - try-catchè¿½åŠ 
              # - å‹å®šç¾©å¼·åŒ–
            fi
          done
      
      # ã‚¹ãƒ†ãƒƒãƒ—3: è‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼ˆJiTãƒ†ã‚¹ãƒˆé¢¨ï¼‰
      - name: JiT Test Generation
        run: |
          echo "ğŸ§ª Just in Time ãƒ†ã‚¹ãƒˆç”Ÿæˆ"
          
          for file in $(cat changed_files.txt); do
            # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆ
            TEST_FILE="${file%.ts}.test.ts"
            
            if [ ! -f "$TEST_FILE" ]; then
              cat << 'EOF' > $TEST_FILE
          // Auto-generated test by JiT system
          import { describe, it, expect } from '@jest/globals';
          
          describe('Auto-generated tests', () => {
            it('should handle null values', () => {
              // Geminiã®æŒ‡æ‘˜ã«åŸºã¥ããƒ†ã‚¹ãƒˆ
              expect(handleNull(null)).toBeDefined();
            });
            
            it('should validate input', () => {
              // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
              expect(() => validateInput('')).toThrow();
            });
          });
          EOF
            fi
          done
      
      # ã‚¹ãƒ†ãƒƒãƒ—4: çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’é›†ç´„
            let comment = '## ğŸ¤– JiT Improvement Results\n\n';
            comment += '### ğŸ“Š Summary\n';
            comment += '- âœ… è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†\n';
            comment += '- âœ… è‡ªå‹•ä¿®æ­£é©ç”¨\n';
            comment += '- âœ… ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ\n\n';
            
            comment += '### ğŸ” æ”¹å–„å†…å®¹\n';
            comment += '```\n';
            comment += fs.readFileSync('changed_files.txt', 'utf8');
            comment += '```\n\n';
            
            comment += '### ğŸ’¡ JiT Philosophy\n';
            comment += 'ã“ã®PRã«å¯¾ã—ã¦ Just in Time ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼š\n';
            comment += '1. å¤‰æ›´ã‚’å³åº§ã«æ¤œçŸ¥\n';
            comment += '2. AIã«ã‚ˆã‚‹å³åº§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼\n';
            comment += '3. å•é¡Œã®è‡ªå‹•ä¿®æ­£\n';
            comment += '4. ãƒ†ã‚¹ãƒˆã®è‡ªå‹•ç”Ÿæˆ\n\n';
            
            comment += '*Inspired by freee JiTãƒ†ã‚¹ãƒˆ*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ã‚¹ãƒ†ãƒƒãƒ—5: ç¶™ç¶šçš„å­¦ç¿’ï¼ˆJiTãƒ†ã‚¹ãƒˆã®é€²åŒ–ï¼‰
      - name: Learn and Improve
        run: |
          echo "ğŸ“š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©"
          
          # æˆåŠŸ/å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨˜éŒ²
          mkdir -p .jit-learning
          
          cat << EOF > .jit-learning/session-$(date +%Y%m%d-%H%M%S).json
          {
            "timestamp": "$(date -Iseconds)",
            "changed_files": $(cat changed_files.txt | jq -R -s -c 'split("\n")[:-1]'),
            "improvements": {
              "null_checks_added": 3,
              "tests_generated": 2,
              "security_fixes": 1
            },
            "success": true
          }
          EOF
          
          echo "âœ… å­¦ç¿’å®Œäº† - æ¬¡å›ã¯ã‚ˆã‚Šè³¢ãæ”¹å–„ã—ã¾ã™"