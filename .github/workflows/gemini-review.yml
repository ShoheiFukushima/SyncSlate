name: Gemini AI Code Review

# mainãƒ–ãƒ©ãƒ³ãƒã«pushã¾ãŸã¯PRãŒä½œæˆ/æ›´æ–°ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚‚å–å¾—ï¼ˆå·®åˆ†ç¢ºèªç”¨ï¼‰
      
      # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          else
            echo "files=$(git diff --name-only HEAD~1..HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi
      
      # Gemini AIã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
      - name: Review with Gemini
        id: gemini-review
        uses: google-github-actions/run-gemini@v1
        with:
          api_key: ${{ secrets.GEMINI_API_KEY }}
          model: gemini-1.5-flash  # é«˜é€Ÿã§å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«
          prompt: |
            ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼š
            ${{ steps.changed-files.outputs.files }}
            
            ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§æ—¥æœ¬èªã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
            
            1. ğŸ› ãƒã‚°ã®å¯èƒ½æ€§ï¼ˆé‡è¦åº¦ï¼šé«˜ï¼‰
            2. ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œï¼ˆé‡è¦åº¦ï¼šé«˜ï¼‰
            3. âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ç‚¹ï¼ˆé‡è¦åº¦ï¼šä¸­ï¼‰
            4. ğŸ“ ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ï¼ˆé‡è¦åº¦ï¼šä½ï¼‰
            
            å„æŒ‡æ‘˜ã«ã¯å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚
            å•é¡ŒãŒãªã„å ´åˆã¯ã€Œâœ… å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
      
      # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’è¡¨ç¤º
      - name: Display review results
        run: |
          echo "## ğŸ¤– Gemini AI Review Results"
          echo "${{ steps.gemini-review.outputs.response }}"
      
      # PRã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `## ğŸ¤– Gemini AI Code Review\n\n${{ steps.gemini-review.outputs.response }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });