name: Gemini Test Analysis

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å¾Œã«å®Ÿè¡Œ
on:
  workflow_run:
    workflows: ["Run Tests", "CI", "Test"]  # æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã«åˆã‚ã›ã¦èª¿æ•´
    types: [completed]

jobs:
  analyze-failure:
    # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸæ™‚ã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œãƒ­ã‚°ã‚’å–å¾—
      - name: Download workflow logs
        uses: actions/github-script@v7
        id: get-logs
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const logs = await github.rest.actions.downloadWorkflowRunLogs({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            return logs.data;
      
      # Geminiã§ã‚¨ãƒ©ãƒ¼åˆ†æ
      - name: Analyze with Gemini
        id: gemini-analysis
        uses: google-github-actions/run-gemini@v1
        with:
          api_key: ${{ secrets.GEMINI_API_KEY }}
          model: gemini-1.5-pro  # ã‚ˆã‚Šè©³ç´°ãªåˆ†æã®ãŸã‚proãƒ¢ãƒ‡ãƒ«ä½¿ç”¨
          prompt: |
            ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
            
            ${{ steps.get-logs.outputs.result }}
            
            æ—¥æœ¬èªã§ä»¥ä¸‹ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š
            
            ## ğŸ“Š ã‚¨ãƒ©ãƒ¼åˆ†æ
            1. ã‚¨ãƒ©ãƒ¼ã®åŸå› ï¼ˆç°¡æ½”ã«ï¼‰
            2. å½±éŸ¿ç¯„å›²
            
            ## ğŸ”§ è§£æ±ºæ–¹æ³•
            å…·ä½“çš„ãªä¿®æ­£æ‰‹é †ã‚’ç®‡æ¡æ›¸ãã§
            
            ## ğŸ’¡ äºˆé˜²ç­–
            ä»Šå¾ŒåŒã˜ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®ææ¡ˆ
            
            ## ğŸ“ ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹
            å¯èƒ½ã§ã‚ã‚Œã°å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ä¾‹ã‚’æç¤º
      
      # Issueã‚’ä½œæˆã—ã¦å ±å‘Š
      - name: Create issue for test failure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analysis = `${{ steps.gemini-analysis.outputs.response }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Test Failure Analysis - ${new Date().toLocaleDateString('ja-JP')}`,
              body: `## ãƒ†ã‚¹ãƒˆå¤±æ•—ã®è‡ªå‹•åˆ†æãƒ¬ãƒãƒ¼ãƒˆ\n\n${analysis}\n\n---\n*This issue was automatically created by Gemini AI*`,
              labels: ['bug', 'test-failure', 'ai-generated']
            });