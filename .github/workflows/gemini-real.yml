name: Gemini Real Actions - å®Ÿéš›ã«å‹•ãGeminiçµ±åˆ

# DISABLED - on:
# DISABLED -   pull_request:
    types: [opened, synchronize]
# DISABLED -   push:
    branches: [main]
# DISABLED -   issue_comment:
    types: [created]
# DISABLED -   workflow_dispatch:
    inputs:
      prompt:
        description: 'Geminiã¸ã®æŒ‡ç¤º'
        required: false
        default: 'ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦æ”¹å–„ç‚¹ã‚’æ•™ãˆã¦'

jobs:
  # Gemini Code Reviewer (truongnh1992ç‰ˆ - å®Ÿç¸¾ã‚ã‚Š)
  gemini-code-review:
    name: Gemini AI Code Review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event.issue.pull_request && contains(github.event.comment.body, '/gemini-review'))
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gemini Code Reviewer
        uses: truongnh1992/gemini-ai-code-reviewer@main
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          LANGUAGE: 'ja'  # æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼
  
  # strawgateç‰ˆ Gemini (ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼)
  gemini-comment-action:
    name: Gemini via Comments
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' && 
      contains(github.event.comment.body, '/gemini')
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Gemini Action
        uses: strawgate/gemini-for-github@0.3
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_issue_number: ${{ github.event.issue.number }}
          user_question: ${{ github.event.comment.body }}
          model: 'gemini-1.5-flash'  # é«˜é€Ÿãƒ¢ãƒ‡ãƒ«
  
  # ç›´æ¥APIå‘¼ã³å‡ºã—ç‰ˆï¼ˆã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ï¼‰
  gemini-direct-api:
    name: Gemini Direct API Call
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Gemini SDK
        run: |
          pip install google-generativeai
      
      - name: Analyze with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          import google.generativeai as genai
          from pathlib import Path
          
          # Geminiè¨­å®š
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          import subprocess
          result = subprocess.run(
              ['git', 'diff', '--name-only', 'HEAD~1..HEAD'],
              capture_output=True, text=True
          )
          changed_files = result.stdout.strip().split('\n')
          
          print("ğŸ¤– Gemini API Analysis")
          print("=" * 50)
          
          for file_path in changed_files:
              if not file_path or not Path(file_path).exists():
                  continue
              
              # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾è±¡
              if not any(file_path.endswith(ext) for ext in ['.ts', '.tsx', '.js', '.jsx', '.py']):
                  continue
              
              print(f"\nğŸ“„ Analyzing: {file_path}")
              
              with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                  code = f.read()
              
              # Geminiã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
              prompt = f"""
              ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
              
              ãƒ•ã‚¡ã‚¤ãƒ«: {file_path}
              ```
              {code[:3000]}  # æœ€åˆã®3000æ–‡å­—ã®ã¿
              ```
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã§æ—¥æœ¬èªã§ç°¡æ½”ã«ç­”ãˆã¦ãã ã•ã„ï¼š
              1. ãƒã‚°ã®å¯èƒ½æ€§
              2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
              3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ç‚¹
              4. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§
              
              å„é …ç›®1-2è¡Œã§ç­”ãˆã¦ãã ã•ã„ã€‚
              """
              
              try:
                  response = model.generate_content(prompt)
                  print(response.text)
              except Exception as e:
                  print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
          
          print("\n" + "=" * 50)
          print("âœ… Geminiåˆ†æå®Œäº†")
          PYTHON
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ğŸ¤– Gemini Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Gemini API" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ¢ãƒ‡ãƒ«: gemini-1.5-flash" >> $GITHUB_STEP_SUMMARY
          echo "- è¨€èª: æ—¥æœ¬èª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY