import React, { useState, useEffect } from 'react';\nimport { AppState, ProcessingData } from '../App';\n\ninterface ProcessingViewProps {\n  state: AppState;\n  data: ProcessingData | null;\n  onCancel: () => void;\n}\n\ninterface ProcessingStep {\n  id: string;\n  title: string;\n  description: string;\n  status: 'pending' | 'running' | 'completed' | 'error';\n  progress: number;\n  details?: string[];\n}\n\nexport function ProcessingView({ state, data, onCancel }: ProcessingViewProps) {\n  const [steps, setSteps] = useState<ProcessingStep[]>([]);\n  const [currentStep, setCurrentStep] = useState<string>('');\n  const [startTime, setStartTime] = useState<number>(Date.now());\n  const [elapsedTime, setElapsedTime] = useState<number>(0);\n  const [estimatedTimeLeft, setEstimatedTimeLeft] = useState<number>(0);\n  \n  useEffect(() => {\n    if (state === 'processing') {\n      initializeSteps();\n      setStartTime(Date.now());\n      \n      // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹\n      const timer = setInterval(() => {\n        const elapsed = Date.now() - startTime;\n        setElapsedTime(elapsed);\n        \n        // æ¨å®šæ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—\n        const completedSteps = steps.filter(s => s.status === 'completed').length;\n        const totalSteps = steps.length;\n        if (completedSteps > 0) {\n          const avgTimePerStep = elapsed / completedSteps;\n          const remainingSteps = totalSteps - completedSteps;\n          setEstimatedTimeLeft(avgTimePerStep * remainingSteps);\n        }\n      }, 1000);\n      \n      return () => clearInterval(timer);\n    }\n  }, [state, startTime, steps]);\n  \n  /**\n   * å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–\n   */\n  const initializeSteps = () => {\n    const baseSteps: ProcessingStep[] = [\n      {\n        id: 'parse',\n        title: 'Parsing Input',\n        description: data?.type === 'xml' ? 'Parsing XML and resolving materials' : 'Preparing audio and video files',\n        status: 'running',\n        progress: 0,\n        details: [\n          data?.type === 'xml' ? 'Reading XML structure' : 'Validating file formats',\n          data?.type === 'xml' ? 'Resolving material paths' : 'Checking file integrity',\n          data?.type === 'xml' ? 'Extracting cue points' : 'Preparing for analysis',\n        ],\n      },\n      {\n        id: 'music',\n        title: 'Music Analysis',\n        description: 'Analyzing audio for beat detection and relative dynamics',\n        status: 'pending',\n        progress: 0,\n        details: [\n          'Beat and onset detection',\n          'Relative dynamics conversion',\n          'Edit point identification',\n          'Musical context analysis',\n        ],\n      },\n      {\n        id: 'video',\n        title: 'Video Analysis',\n        description: 'Analyzing video for shot quality and transitions',\n        status: 'pending',\n        progress: 0,\n        details: [\n          'Shot boundary detection',\n          'Quality assessment',\n          'Hero shot identification',\n          '30% rule validation',\n        ],\n      },\n      {\n        id: 'matching',\n        title: 'Time-based Matching',\n        description: 'Generating edit patterns with segment-specific strategies',\n        status: 'pending',\n        progress: 0,\n        details: [\n          'Dynamic Cut pattern',\n          'Narrative Flow pattern',\n          'Hybrid Balance pattern',\n          'Pattern evaluation',\n        ],\n      },\n      {\n        id: 'qa',\n        title: 'Quality Assurance',\n        description: 'Running comprehensive validation suite',\n        status: 'pending',\n        progress: 0,\n        details: [\n          'Confidence validation',\n          '30% rule compliance',\n          'Segment transition check',\n          'Technical quality metrics',\n        ],\n      },\n      {\n        id: 'output',\n        title: 'Output Generation',\n        description: 'Creating XML, explain.json, and QA report',\n        status: 'pending',\n        progress: 0,\n        details: [\n          'Premiere XML generation',\n          'Explain.json creation',\n          'QA report compilation',\n          'File system output',\n        ],\n      },\n    ];\n    \n    setSteps(baseSteps);\n    setCurrentStep('parse');\n    \n    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®é€²æ—æ›´æ–°\n    simulateProgress(baseSteps);\n  };\n  \n  /**\n   * é€²æ—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ãƒªã‚¢ãƒ«ãªé€²æ—ã‚’å—ä¿¡ï¼‰\n   */\n  const simulateProgress = async (initialSteps: ProcessingStep[]) => {\n    const stepDurations = [3000, 8000, 6000, 10000, 4000, 2000]; // å„ã‚¹ãƒ†ãƒƒãƒ—ã®æ¨å®šæ™‚é–“\n    \n    for (let i = 0; i < initialSteps.length; i++) {\n      const stepId = initialSteps[i].id;\n      setCurrentStep(stepId);\n      \n      // ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹çŠ¶æ…‹ã«\n      setSteps(prev => prev.map(step => \n        step.id === stepId \n          ? { ...step, status: 'running' as const }\n          : step\n      ));\n      \n      // é€²æ—ã‚’æ®µéšçš„ã«æ›´æ–°\n      const duration = stepDurations[i];\n      const updateInterval = duration / 20; // 20å›ã«åˆ†ã‘ã¦æ›´æ–°\n      \n      for (let progress = 0; progress <= 100; progress += 5) {\n        await new Promise(resolve => setTimeout(resolve, updateInterval));\n        \n        setSteps(prev => prev.map(step => \n          step.id === stepId \n            ? { ...step, progress }\n            : step\n        ));\n      }\n      \n      // ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†çŠ¶æ…‹ã«\n      setSteps(prev => prev.map(step => \n        step.id === stepId \n          ? { ...step, status: 'completed' as const, progress: 100 }\n          : step\n      ));\n    }\n  };\n  \n  /**\n   * æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ\n   */\n  const formatTime = (ms: number): string => {\n    const seconds = Math.floor(ms / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const remainingSeconds = seconds % 60;\n    \n    if (minutes > 0) {\n      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;\n    } else {\n      return `${remainingSeconds}s`;\n    }\n  };\n  \n  /**\n   * å…¨ä½“ã®é€²æ—ã‚’è¨ˆç®—\n   */\n  const calculateOverallProgress = (): number => {\n    if (steps.length === 0) return 0;\n    \n    const totalProgress = steps.reduce((sum, step) => sum + step.progress, 0);\n    return Math.round(totalProgress / steps.length);\n  };\n  \n  /**\n   * ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—\n   */\n  const getStepIcon = (step: ProcessingStep): string => {\n    switch (step.status) {\n      case 'completed':\n        return 'âœ…';\n      case 'running':\n        return 'âš¡';\n      case 'error':\n        return 'âŒ';\n      default:\n        return 'â³';\n    }\n  };\n  \n  const overallProgress = calculateOverallProgress();\n  \n  return (\n    <div className=\"processing-view\">\n      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}\n      <div className=\"processing-header\">\n        <h2>Processing {data?.type === 'xml' ? 'XML Project' : 'Audio & Video Files'}</h2>\n        <p>AutoEditTATE is analyzing your content and generating edit patterns...</p>\n      </div>\n      \n      {/* å…¨ä½“ã®é€²æ— */}\n      <div className=\"overall-progress\">\n        <div className=\"progress-info\">\n          <span className=\"progress-text\">{overallProgress}% Complete</span>\n          <div className=\"time-info\">\n            <span>Elapsed: {formatTime(elapsedTime)}</span>\n            {estimatedTimeLeft > 0 && (\n              <span>Estimated: {formatTime(estimatedTimeLeft)} left</span>\n            )}\n          </div>\n        </div>\n        <div className=\"progress-bar\">\n          <div \n            className=\"progress-fill\"\n            style={{ width: `${overallProgress}%` }}\n          />\n        </div>\n      </div>\n      \n      {/* ã‚¹ãƒ†ãƒƒãƒ—ãƒªã‚¹ãƒˆ */}\n      <div className=\"processing-steps\">\n        {steps.map((step, index) => (\n          <div \n            key={step.id}\n            className={`processing-step ${step.status} ${currentStep === step.id ? 'current' : ''}`}\n          >\n            <div className=\"step-header\">\n              <div className=\"step-indicator\">\n                <span className=\"step-icon\">{getStepIcon(step)}</span>\n                <span className=\"step-number\">{index + 1}</span>\n              </div>\n              \n              <div className=\"step-content\">\n                <h3 className=\"step-title\">{step.title}</h3>\n                <p className=\"step-description\">{step.description}</p>\n                \n                {step.status === 'running' && (\n                  <div className=\"step-progress\">\n                    <div className=\"step-progress-bar\">\n                      <div \n                        className=\"step-progress-fill\"\n                        style={{ width: `${step.progress}%` }}\n                      />\n                    </div>\n                    <span className=\"step-progress-text\">{step.progress}%</span>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"step-status\">\n                {step.status === 'completed' && (\n                  <span className=\"status-badge completed\">âœ“ Done</span>\n                )}\n                {step.status === 'running' && (\n                  <span className=\"status-badge running\">Running...</span>\n                )}\n                {step.status === 'pending' && (\n                  <span className=\"status-badge pending\">Waiting</span>\n                )}\n              </div>\n            </div>\n            \n            {/* ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´° */}\n            {(step.status === 'running' || step.status === 'completed') && step.details && (\n              <div className=\"step-details\">\n                {step.details.map((detail, detailIndex) => {\n                  const isCompleted = step.status === 'completed' || \n                    (step.status === 'running' && detailIndex < (step.progress / 100) * step.details!.length);\n                  \n                  return (\n                    <div \n                      key={detailIndex}\n                      className={`step-detail ${isCompleted ? 'completed' : 'pending'}`}\n                    >\n                      <span className=\"detail-icon\">\n                        {isCompleted ? 'âœ“' : 'â—‹'}\n                      </span>\n                      <span className=\"detail-text\">{detail}</span>\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n          </div>\n        ))}\n      </div>\n      \n      {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}\n      <div className=\"processing-actions\">\n        <button \n          className=\"cancel-button\"\n          onClick={onCancel}\n        >\n          Cancel Processing\n        </button>\n      </div>\n      \n      {/* å‡¦ç†ã®ãƒ’ãƒ³ãƒˆ */}\n      <div className=\"processing-tips\">\n        <h4>ğŸ’¡ Processing Tips:</h4>\n        <ul>\n          <li>Music analysis uses relative dynamics - all values are normalized within the song</li>\n          <li>Video analysis applies the 30% change rule for smooth transitions</li>\n          <li>Three patterns are generated: Dynamic Cut, Narrative Flow, and Hybrid Balance</li>\n          <li>QA validation ensures aggregate confidence â‰¥ 88% for quality output</li>\n        </ul>\n      </div>\n    </div>\n  );\n}