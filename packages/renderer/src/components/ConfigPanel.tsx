import React, { useState, useEffect } from 'react';\n\ninterface ConfigPanelProps {\n  onClose: () => void;\n  onConfigUpdate: () => void;\n}\n\ninterface ConfigData {\n  analysis: {\n    music: {\n      beatDetectionSensitivity: number;\n      onsetDetectionThreshold: number;\n      relativeDynamicsWindow: number;\n    };\n    video: {\n      shotDetectionThreshold: number;\n      qualityAssessmentStrict: boolean;\n      heroShotEdgeComplexity: number;\n    };\n  };\n  matching: {\n    segments: {\n      opening: { visual: number; sync: number; semantic: number; stability: number };\n      engagement: { visual: number; sync: number; semantic: number; stability: number };\n      buildup: { visual: number; sync: number; semantic: number; stability: number };\n      climax: { visual: number; sync: number; semantic: number; stability: number };\n      outro: { visual: number; sync: number; semantic: number; stability: number };\n    };\n    constraints: {\n      maxCuts: number;\n      minShotDuration: number;\n      targetDuration: number;\n    };\n  };\n  quality: {\n    confidenceThreshold: number;\n    thirtyPercentRuleStrict: boolean;\n    requireHeroShots: boolean;\n    qaValidationStrict: boolean;\n  };\n}\n\nconst DEFAULT_CONFIG: ConfigData = {\n  analysis: {\n    music: {\n      beatDetectionSensitivity: 0.7,\n      onsetDetectionThreshold: 0.5,\n      relativeDynamicsWindow: 4000,\n    },\n    video: {\n      shotDetectionThreshold: 0.3,\n      qualityAssessmentStrict: false,\n      heroShotEdgeComplexity: 0.6,\n    },\n  },\n  matching: {\n    segments: {\n      opening: { visual: 0.5, sync: 0.2, semantic: 0.2, stability: 0.1 },\n      engagement: { visual: 0.3, sync: 0.3, semantic: 0.3, stability: 0.1 },\n      buildup: { visual: 0.25, sync: 0.4, semantic: 0.25, stability: 0.1 },\n      climax: { visual: 0.35, sync: 0.4, semantic: 0.15, stability: 0.1 },\n      outro: { visual: 0.4, sync: 0.2, semantic: 0.3, stability: 0.1 },\n    },\n    constraints: {\n      maxCuts: 20,\n      minShotDuration: 500,\n      targetDuration: 60000,\n    },\n  },\n  quality: {\n    confidenceThreshold: 0.88,\n    thirtyPercentRuleStrict: true,\n    requireHeroShots: false,\n    qaValidationStrict: true,\n  },\n};\n\nexport function ConfigPanel({ onClose, onConfigUpdate }: ConfigPanelProps) {\n  const [config, setConfig] = useState<ConfigData>(DEFAULT_CONFIG);\n  const [activeTab, setActiveTab] = useState<string>('analysis');\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState<boolean>(false);\n  const [isSaving, setIsSaving] = useState<boolean>(false);\n  \n  useEffect(() => {\n    // 現在の設定を読み込み\n    loadCurrentConfig();\n  }, []);\n  \n  /**\n   * 現在の設定を読み込み\n   */\n  const loadCurrentConfig = async () => {\n    try {\n      // 実際の実装では、electronAPI経由で設定を読み込み\n      // const currentConfig = await window.electronAPI.config.load();\n      // setConfig(currentConfig || DEFAULT_CONFIG);\n      \n      // 現在はデフォルト設定を使用\n      setConfig(DEFAULT_CONFIG);\n    } catch (error) {\n      console.error('Failed to load config:', error);\n    }\n  };\n  \n  /**\n   * 設定値を更新\n   */\n  const updateConfig = (path: string, value: any) => {\n    setConfig(prev => {\n      const newConfig = { ...prev };\n      const pathParts = path.split('.');\n      let current: any = newConfig;\n      \n      for (let i = 0; i < pathParts.length - 1; i++) {\n        current = current[pathParts[i]];\n      }\n      \n      current[pathParts[pathParts.length - 1]] = value;\n      return newConfig;\n    });\n    \n    setHasUnsavedChanges(true);\n  };\n  \n  /**\n   * セグメント重みを更新\n   */\n  const updateSegmentWeight = (segment: string, weight: string, value: number) => {\n    updateConfig(`matching.segments.${segment}.${weight}`, value);\n  };\n  \n  /**\n   * 設定を保存\n   */\n  const saveConfig = async () => {\n    setIsSaving(true);\n    \n    try {\n      // 実際の実装では、electronAPI経由で設定を保存\n      // await window.electronAPI.autoEdit.updateConfig(config);\n      \n      // 2秒間のシミュレート\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      \n      setHasUnsavedChanges(false);\n      onConfigUpdate();\n      \n      alert('Configuration saved successfully!');\n    } catch (error) {\n      console.error('Failed to save config:', error);\n      alert(`Failed to save configuration: ${error}`);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n  \n  /**\n   * デフォルト設定にリセット\n   */\n  const resetToDefaults = () => {\n    if (confirm('Are you sure you want to reset all settings to defaults?')) {\n      setConfig(DEFAULT_CONFIG);\n      setHasUnsavedChanges(true);\n    }\n  };\n  \n  /**\n   * 数値入力コンポーネント\n   */\n  const NumberInput = ({ \n    label, \n    value, \n    onChange, \n    min = 0, \n    max = 1, \n    step = 0.1, \n    unit = '' \n  }: {\n    label: string;\n    value: number;\n    onChange: (value: number) => void;\n    min?: number;\n    max?: number;\n    step?: number;\n    unit?: string;\n  }) => (\n    <div className=\"config-input\">\n      <label className=\"config-label\">\n        {label}\n        {unit && <span className=\"input-unit\">({unit})</span>}\n      </label>\n      <div className=\"input-with-slider\">\n        <input\n          type=\"number\"\n          value={value}\n          onChange={(e) => onChange(parseFloat(e.target.value) || 0)}\n          min={min}\n          max={max}\n          step={step}\n          className=\"number-input\"\n        />\n        <input\n          type=\"range\"\n          value={value}\n          onChange={(e) => onChange(parseFloat(e.target.value))}\n          min={min}\n          max={max}\n          step={step}\n          className=\"range-slider\"\n        />\n      </div>\n    </div>\n  );\n  \n  /**\n   * チェックボックスコンポーネント\n   */\n  const CheckboxInput = ({ \n    label, \n    value, \n    onChange, \n    description \n  }: {\n    label: string;\n    value: boolean;\n    onChange: (value: boolean) => void;\n    description?: string;\n  }) => (\n    <div className=\"config-input\">\n      <label className=\"config-label checkbox-label\">\n        <input\n          type=\"checkbox\"\n          checked={value}\n          onChange={(e) => onChange(e.target.checked)}\n          className=\"checkbox-input\"\n        />\n        <span className=\"checkbox-text\">{label}</span>\n      </label>\n      {description && <p className=\"input-description\">{description}</p>}\n    </div>\n  );\n  \n  /**\n   * セグメント重み調整コンポーネント\n   */\n  const SegmentWeights = ({ segment }: { segment: string }) => {\n    const weights = config.matching.segments[segment as keyof typeof config.matching.segments];\n    \n    return (\n      <div className=\"segment-weights\">\n        <h4 className=\"segment-title\">{segment.charAt(0).toUpperCase() + segment.slice(1)}</h4>\n        <div className=\"weights-grid\">\n          <NumberInput\n            label=\"Visual\"\n            value={weights.visual}\n            onChange={(value) => updateSegmentWeight(segment, 'visual', value)}\n            max={1}\n            step={0.05}\n          />\n          <NumberInput\n            label=\"Sync\"\n            value={weights.sync}\n            onChange={(value) => updateSegmentWeight(segment, 'sync', value)}\n            max={1}\n            step={0.05}\n          />\n          <NumberInput\n            label=\"Semantic\"\n            value={weights.semantic}\n            onChange={(value) => updateSegmentWeight(segment, 'semantic', value)}\n            max={1}\n            step={0.05}\n          />\n          <NumberInput\n            label=\"Stability\"\n            value={weights.stability}\n            onChange={(value) => updateSegmentWeight(segment, 'stability', value)}\n            max={1}\n            step={0.05}\n          />\n        </div>\n        <div className=\"weights-total\">\n          Total: {(weights.visual + weights.sync + weights.semantic + weights.stability).toFixed(2)}\n          {Math.abs(weights.visual + weights.sync + weights.semantic + weights.stability - 1) > 0.01 && (\n            <span className=\"total-warning\">⚠️ Should sum to 1.0</span>\n          )}\n        </div>\n      </div>\n    );\n  };\n  \n  return (\n    <div className=\"config-panel-overlay\">\n      <div className=\"config-panel\">\n        {/* ヘッダー */}\n        <div className=\"config-header\">\n          <h2>AutoEditTATE Settings</h2>\n          <button className=\"close-button\" onClick={onClose}>\n            ✕\n          </button>\n        </div>\n        \n        {/* タブナビゲーション */}\n        <div className=\"config-tabs\">\n          <button \n            className={`tab-button ${activeTab === 'analysis' ? 'active' : ''}`}\n            onClick={() => setActiveTab('analysis')}\n          >\n            Analysis\n          </button>\n          <button \n            className={`tab-button ${activeTab === 'matching' ? 'active' : ''}`}\n            onClick={() => setActiveTab('matching')}\n          >\n            Matching\n          </button>\n          <button \n            className={`tab-button ${activeTab === 'quality' ? 'active' : ''}`}\n            onClick={() => setActiveTab('quality')}\n          >\n            Quality\n          </button>\n        </div>\n        \n        {/* 設定内容 */}\n        <div className=\"config-content\">\n          {activeTab === 'analysis' && (\n            <div className=\"config-section\">\n              <h3>Analysis Settings</h3>\n              \n              <div className=\"subsection\">\n                <h4>Music Analysis</h4>\n                <NumberInput\n                  label=\"Beat Detection Sensitivity\"\n                  value={config.analysis.music.beatDetectionSensitivity}\n                  onChange={(value) => updateConfig('analysis.music.beatDetectionSensitivity', value)}\n                />\n                <NumberInput\n                  label=\"Onset Detection Threshold\"\n                  value={config.analysis.music.onsetDetectionThreshold}\n                  onChange={(value) => updateConfig('analysis.music.onsetDetectionThreshold', value)}\n                />\n                <NumberInput\n                  label=\"Relative Dynamics Window\"\n                  value={config.analysis.music.relativeDynamicsWindow}\n                  onChange={(value) => updateConfig('analysis.music.relativeDynamicsWindow', value)}\n                  min={1000}\n                  max={10000}\n                  step={500}\n                  unit=\"ms\"\n                />\n              </div>\n              \n              <div className=\"subsection\">\n                <h4>Video Analysis</h4>\n                <NumberInput\n                  label=\"Shot Detection Threshold\"\n                  value={config.analysis.video.shotDetectionThreshold}\n                  onChange={(value) => updateConfig('analysis.video.shotDetectionThreshold', value)}\n                />\n                <NumberInput\n                  label=\"Hero Shot Edge Complexity\"\n                  value={config.analysis.video.heroShotEdgeComplexity}\n                  onChange={(value) => updateConfig('analysis.video.heroShotEdgeComplexity', value)}\n                />\n                <CheckboxInput\n                  label=\"Strict Quality Assessment\"\n                  value={config.analysis.video.qualityAssessmentStrict}\n                  onChange={(value) => updateConfig('analysis.video.qualityAssessmentStrict', value)}\n                  description=\"Apply stricter quality criteria for shot selection\"\n                />\n              </div>\n            </div>\n          )}\n          \n          {activeTab === 'matching' && (\n            <div className=\"config-section\">\n              <h3>Matching Settings</h3>\n              \n              <div className=\"subsection\">\n                <h4>Segment Weights</h4>\n                <p>Adjust the importance of different factors for each time segment:</p>\n                \n                <div className=\"segments-container\">\n                  {Object.keys(config.matching.segments).map(segment => (\n                    <SegmentWeights key={segment} segment={segment} />\n                  ))}\n                </div>\n              </div>\n              \n              <div className=\"subsection\">\n                <h4>Constraints</h4>\n                <NumberInput\n                  label=\"Maximum Cuts\"\n                  value={config.matching.constraints.maxCuts}\n                  onChange={(value) => updateConfig('matching.constraints.maxCuts', value)}\n                  min={5}\n                  max={50}\n                  step={1}\n                />\n                <NumberInput\n                  label=\"Minimum Shot Duration\"\n                  value={config.matching.constraints.minShotDuration}\n                  onChange={(value) => updateConfig('matching.constraints.minShotDuration', value)}\n                  min={100}\n                  max={5000}\n                  step={100}\n                  unit=\"ms\"\n                />\n                <NumberInput\n                  label=\"Target Duration\"\n                  value={config.matching.constraints.targetDuration}\n                  onChange={(value) => updateConfig('matching.constraints.targetDuration', value)}\n                  min={15000}\n                  max={120000}\n                  step={5000}\n                  unit=\"ms\"\n                />\n              </div>\n            </div>\n          )}\n          \n          {activeTab === 'quality' && (\n            <div className=\"config-section\">\n              <h3>Quality Settings</h3>\n              \n              <NumberInput\n                label=\"Confidence Threshold\"\n                value={config.quality.confidenceThreshold}\n                onChange={(value) => updateConfig('quality.confidenceThreshold', value)}\n                min={0.5}\n                max={1}\n                step={0.01}\n              />\n              \n              <CheckboxInput\n                label=\"Strict 30% Rule Enforcement\"\n                value={config.quality.thirtyPercentRuleStrict}\n                onChange={(value) => updateConfig('quality.thirtyPercentRuleStrict', value)}\n                description=\"Strictly enforce the 30% change rule for all transitions\"\n              />\n              \n              <CheckboxInput\n                label=\"Require Hero Shots\"\n                value={config.quality.requireHeroShots}\n                onChange={(value) => updateConfig('quality.requireHeroShots', value)}\n                description=\"Require at least one hero shot in the opening segment\"\n              />\n              \n              <CheckboxInput\n                label=\"Strict QA Validation\"\n                value={config.quality.qaValidationStrict}\n                onChange={(value) => updateConfig('quality.qaValidationStrict', value)}\n                description=\"Apply stricter quality assurance validation\"\n              />\n            </div>\n          )}\n        </div>\n        \n        {/* アクションボタン */}\n        <div className=\"config-actions\">\n          <div className=\"left-actions\">\n            <button className=\"reset-button\" onClick={resetToDefaults}>\n              Reset to Defaults\n            </button>\n          </div>\n          \n          <div className=\"right-actions\">\n            <button className=\"cancel-button\" onClick={onClose}>\n              Cancel\n            </button>\n            <button \n              className={`save-button ${hasUnsavedChanges ? 'has-changes' : ''}`}\n              onClick={saveConfig}\n              disabled={isSaving || !hasUnsavedChanges}\n            >\n              {isSaving ? (\n                <>\n                  <span className=\"loading-spinner\"></span>\n                  Saving...\n                </>\n              ) : (\n                <>\n                  {hasUnsavedChanges && <span className=\"changes-indicator\">●</span>}\n                  Save Changes\n                </>\n              )}\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}